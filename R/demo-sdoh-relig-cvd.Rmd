---
title: "Demographics, Social Determinants of Health, Risk Factors, Cardiovascular Disease"
output: 
  html_notebook: 
    toc: yes
    toc_float: yes
    fig_width: 4
    theme: paper
editor_options: 
  chunk_output_type: inline
---

# Data

```{r, include = FALSE}
#notebook settings - no messages or warnings in chunk output
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r, warning = FALSE, message = TRUE}
#import libraries
library(tidyverse)
library(kableExtra)
library(gtsummary)
library(foreign)
library(knitr)
library(blorr)
library(vtable)
library(leaps)
library(gridExtra)
library(MASS)
library(caret)
library(poliscidata)
library(MuMIn)
library(flexmix)
library(pROC)
library(modelsummary)
library(corrr)
library(corrplot)
library(car)
```

```{r import data}
#demographics
#DEMO
xpt <- foreign::read.xport("../Data/DEMO_E.XPT")

#capture demographics and rename into data
data <- xpt[c("SEQN", "RIAGENDR", "RIDAGEYR", "RIDRETH1", "DMDEDUC2", "DMDMARTL", "DMDBORN2")] %>% 
  rename(gender = RIAGENDR,
         age = RIDAGEYR,
         ethnicity = RIDRETH1,
         education = DMDEDUC2,
         marital_status = DMDMARTL,
         born_outside_us = DMDBORN2)

#SMQ
#TOBACCO
xpt <- foreign::read.xport("../Data/SMQ_E.xpt")
data <- merge(data, xpt[c("SEQN","SMQ020", "SMQ040")], by = "SEQN", all.x = TRUE) %>% 
  rename(cigs_100 = SMQ020,
         cigs_now = SMQ040)

#never smoked, past smoker, current smoker
data <- data %>% 
  mutate(cigarette_use = case_when(
    #never smoked - 'no' to "have you ever smoked 100 cigarettes"
    cigs_100 == 2 ~ "Never smoked",
    #past smoker - smoked 100 cigs in life but does not smoke now
    cigs_100 == 1 & cigs_now == 3 ~ "Past smoker",
    #current smoker - smoked 100 cigs and smokes every day or some days
    cigs_100 == 1 & cigs_now %in% c(1,2) ~ "Current smoker"
  ))

data <- data %>% 
  mutate(cigarette_use = factor(cigarette_use, levels = c("Never smoked", "Past smoker", "Current smoker")))

# xpt <- foreign::read.xport("../Data/SMQ_E.xpt")
# data <- merge(data, xpt[c("SEQN","SMQ020", "SMQ040")], by = "SEQN", all.x = TRUE)
#data <- data %>% 
#  mutate(tobacco_use = case_when(
  #   SMQ020 == 2  ~ "Never",
  #   SMQ040 %in% c(1,2) ~ "Current",
  #   SMQ040 == 3 ~ "Former",
  #   TRUE ~ as.character("Not asked")
  # ))

#set factor levels for tobacco
# data <- data %>% 
#   mutate(tobacco_use = factor(tobacco_use, levels = c("Never", "Current", "Former")))

#WHQ
#height is inches
#weight is pounds
xpt <- foreign::read.xport("../Data/WHQ_E.xpt")
data <- merge(data, xpt[c("SEQN","WHD010", "WHD020")], by = "SEQN", all.x = TRUE) %>% 
  rename(height = WHD010,
         weight = WHD020) %>% 
  filter(!(height %in% c(7777, 9999)),
         !(weight %in% c(7777,9999)))

#BMI
#formula: weight (lb) / height (in) / height (in) * 703
data$BMI <- round(data$weight / data$height / data$height * 703, 1)

#DPQ
#depression
xpt <- foreign::read.xport("../Data/DPQ_E.xpt")
data <- merge(data, xpt[c("SEQN","DPQ010", "DPQ020", "DPQ030","DPQ040", 
                          "DPQ050", "DPQ060", "DPQ070", "DPQ080", "DPQ090"
                          )], by = "SEQN", all.x = TRUE)

#set depression values to NA if refused, don't know, or missing
data <- data %>% 
  mutate(DPQ010 = replace(DPQ010, DPQ010 == 9, NA),
         DPQ020 = replace(DPQ020, DPQ020 == 9, NA),
         DPQ030 = replace(DPQ030, DPQ030 == 9, NA),
         DPQ040 = replace(DPQ040, DPQ040 == 9, NA),
         DPQ050 = replace(DPQ050, DPQ050 == 9, NA),
         DPQ060 = replace(DPQ060, DPQ060 == 9, NA),
         DPQ070 = replace(DPQ070, DPQ070 == 9, NA),
         DPQ080 = replace(DPQ080, DPQ080 == 9, NA),
         DPQ090 = replace(DPQ090, DPQ090 == 9, NA)
         )

data <- data %>% 
  group_by(SEQN) %>% 
  mutate(depression_count = sum(c(is.na(c(DPQ010, DPQ020, DPQ030, DPQ040, 
                                          DPQ050, DPQ060, DPQ070, DPQ080, 
                                          DPQ090)))))

data %>% 
  filter(depression_count > 0, age >= 40, depression_count < 9) %>% 
  arrange(-depression_count)

#depression
#sum depression if there's at least 5 values
data <- data %>% 
  mutate(depression = case_when(
    depression_count <= 5 ~ sum(DPQ010, DPQ020, DPQ030, DPQ040, 
                                DPQ050, DPQ060, DPQ070, DPQ080, 
                                DPQ090, na.rm = TRUE)))

#HOQ
#home owned, bought, rented, other
xpt <- foreign::read.xport("../Data/HOQ_E.xpt")
data <- merge(data, xpt[c("SEQN","HOQ065")], by = "SEQN", all.x = TRUE) %>% 
  rename(home = HOQ065)
data <- data %>% 
  mutate(home = factor(home, levels = c(1,2,3,7,9, '.'), labels = c("Owned or being bought", 
                                                                    "Rented", "Other Arrangement", 
                                                                    "Refused", "Don't know", "Missing")))


#INQ
#poverty level
xpt <- foreign::read.xport("../Data/INQ_E.xpt")
data <- merge(data, xpt[c("SEQN", "INDFMMPI", "INDFMMPC")], by = "SEQN", all.x = TRUE) %>% 
  rename(poverty_level_index = INDFMMPI,
         poverty_level_category = INDFMMPC)

#HIQ
#health insurance
xpt <- foreign::read.xport("../Data/HIQ_E.xpt")
data <- merge(data, xpt[c("SEQN", "HIQ011", "HIQ031A", "HIQ031B", "HIQ031D")], by = "SEQN", all.x = TRUE) %>% 
  rename(health_insurance = HIQ011,
         private_insurance = HIQ031A,
         medicare = HIQ031B,
         medicaid = HIQ031D)

#HUQ
#number of healthcare visits
xpt <- foreign::read.xport("../Data/HUQ_E.xpt")
data <- merge(data, xpt[c("SEQN", "HUQ050", "HUQ030")], by = "SEQN", all.x = TRUE) %>% 
  rename(num_healthcare_visits = HUQ050,
         health_care_access = HUQ030) %>% 
  mutate(num_healthcare_visits = case_when(
    num_healthcare_visits %in% c(0,1) ~ "1",
    TRUE ~ as.character(num_healthcare_visits)),
    health_care_access = factor(health_care_access, levels = c(1,2,3,7,9,"."), 
                                labels = c("Yes", "There is no place", 
                                           "There is more than one place", "Refused", 
                                           "Don't know", "Missing"))
  )

#FSQ
#food stamps, food insecurity
xpt <- foreign::read.xport("../Data/FSQ_E.xpt")
data <- merge(data, xpt[c("SEQN", "FSQ165", "FSQ171", "FSD670ZC", "FSD032A", "FSD032B")],
              by = "SEQN", all.x = TRUE) %>% 
  rename(ever_received_food_stamps = FSQ165,
         #food_stamps_past_yr = FSQ171,
         num_months_WIC = FSD670ZC,
         worried_house_run_out_food = FSD032A,
         food_ran_out = FSD032B)

#PFQ
#risk_mobility
# xpt <- foreign::read.xport("../Data/PFQ_E.xpt")
# data <- merge(data, xpt[c("SEQN","PFQ054")], by = "SEQN", all.x = TRUE)
# data <- data %>%   
#   dplyr::rename(difficulty_walking = PFQ054) 

#set factor levels for difficulty walking
# data$difficulty_walking <- factor(data$difficulty_walking, levels = c(2,1), labels = c("No", "Yes"))

#BPQ
#blood pressure at risk
xpt <- foreign::read.xport("../Data/BPQ_E.xpt")
data <- merge(data,xpt[c("SEQN", "BPQ020", "BPQ080")], by = "SEQN", all.x = TRUE) %>% 
  rename(high_blood_pressure = BPQ020,
         cholesterol = BPQ080)

data <- data %>% 
  mutate(cholesterol = factor(cholesterol, levels = c(1,2), labels = c("Yes", "No")))
  
#GLU
#fasting glucose
# xpt <- foreign::read.xport("../Data/GLU_E.xpt")
# data <- merge(data, xpt[c("SEQN", "LBDGLUSI")], by = "SEQN", all.x = TRUE) %>%
#   rename(fasting_glucose = LBDGLUSI)

#fasting glucose
#data <- data %>% 
#  mutate(fasting_glucose = case_when(
#    fasting_glucose <= 4.995 ~ "Not at Risk",
#    fasting_glucose > 4.995 ~ "At Risk",
#    is.na(fasting_glucose) ~ "Unknown"
#  ))

#risk_glucose
#data$fasting_glucose <- factor(data$fasting_glucose, levels = c("Not at Risk", "At Risk"), c("Not at Risk", "At Risk"))
#data <- data %>% 
#  mutate(risk_glucose = case_when(
#    fasting_glucose == "At Risk" ~ 1,
#    TRUE ~ as.double(0)
#  ))

#ALQ
#alcohol consumption
# xpt <- foreign::read.xport("../Data/ALQ_E.xpt")
# data <- merge(data, xpt[c("SEQN", "ALQ101", "ALQ130", "ALQ120Q", "ALQ120U", "ALQ140Q", "ALQ140U", "ALQ110")], by = "SEQN", all.x = TRUE) %>% 
#   mutate(had_12_drinks_in_1yr = ALQ101,
#          avg_drinks_daily_past_yr = ALQ130,
#          num_drinks_past_yr = ALQ120Q,
#          num_drinks_past_yr_unit = ALQ120U,
#          num_days_5_drinks_or_more = ALQ140Q,
#          had_12_drinks_lifetime = ALQ110)

#ALCOHOL CONSUMPTION factor levels
# data <- data %>% 
#   mutate(alcohol_consumption = case_when(
#     ALQ101 == 2 & ALQ110 == 2  ~ "Never",
#     ALQ101 == 1  & ALQ120Q == 0 ~ "Past drinker",
#     ALQ101 == 1 & ((ALQ120Q > 0 & ALQ120Q <= 365) | (ALQ130 > 0 & ALQ130 <= 83) | (ALQ140Q > 0 & ALQ140Q <= 365)) ~ "Current Drinker",
#     is.na(ALQ101) ~ "Not Asked",
#     is.na(ALQ120Q) ~ "Not Asked",
#     is.na(ALQ130) ~ "Not Asked",
#     ALQ101 == 9 | ALQ110 == 9 | ALQ120Q == 999 | ALQ130 == 999 | ALQ140U | 9999 ~ "NA",
#     TRUE ~ as.character("Other")
#   )) %>% 
#   mutate(alcohol_consumption = factor(alcohol_consumption, levels = c("Never", "Current Drinker", "Past drinker", "Not Asked", "Other")))

#SSQ
#RELIGIOUS ATTENDANCE
xpt <- foreign::read.xport("../Data/SSQ_E.xpt")

data <- merge(data, xpt[c("SEQN", "SSD044", "SSQ011")], by = "SEQN", all.x = TRUE) %>% 
  rename(religious_attendance = SSD044,
         emotional_support = SSQ011) 
data <- data %>% 
  mutate(emotional_support = factor(emotional_support, levels = c(1,2,3), labels = c("Yes", "No", "SP doesn't need help")))

#MCQ
#heart attack and stroke
xpt <- foreign::read.xport("../Data/MCQ_E.xpt")
data <- merge(data, xpt[c("SEQN", "MCQ160E", "MCQ160F", "MCQ160B", "MCQ160C", "MCQ160D")], by = "SEQN", all.x = TRUE) %>% 
  rename(heart_attack = MCQ160E,
         stroke = MCQ160F,
         congestive = MCQ160B,
         coronary = MCQ160C,
         angina = MCQ160D)

data <- data %>% 
  mutate(congestive = factor(congestive, levels = c(1,2), labels = c("Yes", "No")),
         coronary = factor(coronary, levels = c(1,2), labels = c("Yes", "No")),
         angina = factor(angina, levels = c(1,2), labels = c("Yes", "No")))

#DIQ
#diabetes
xpt <- foreign::read.xport("../Data/DIQ_E.xpt")
data <- merge(data, xpt[c("SEQN", "DIQ010")], by = "SEQN", all.x = TRUE) %>% 
  rename(diabetes = DIQ010)

data <- data %>% 
  mutate(diabetes = factor(diabetes, levels = c(1,2,3), labels = c("Yes", "No", "Borderline")))

#set gender factor levels
data$gender <- factor(data$gender,levels = c(1,2), labels = c("Male", "Female"))

#ethnicity
data <- data %>% 
  mutate(ethnicity = case_when(
    ethnicity %in% c(1,2) ~ 1,
    TRUE ~ as.double(ethnicity)
  ))

#set ethnicity factor levels
#will be NA if not one of these three, to be filtered out later
data$ethnicity <- factor(data$ethnicity, levels = c(3,1,4), labels = c( "Non-Hispanic White", "Hispanic", "Non-Hispanic Black"))

#set education factor levels
data$education <- factor(data$education, levels = c(3,1,2,4,5), labels = c( "High School/GED", "Less than 9th grade", "9-11th Grade","Some college", "College Graduate or above"))

#refactor education
data <- data %>% 
  mutate(education = case_when(
    education %in% c("Less than 9th grade", "9-11th Grade") ~ "Less than High School",
    TRUE ~ as.character(education)
  ))

#specify factor levels and order for education
data$education <- factor(data$education, levels = c("High School/GED", "Less than High School", "Some college", "College Graduate or above"), labels = c("High School/GED", "Less than High School", "Some college", "College Graduate or above"))

#set factor for marital status
data$marital_status <- factor(data$marital_status, levels = c(5,1,2,3,4,6), labels = c("Never Married", "Married", "Widowed", "Divorced", "Separated", "Living with partner"))

#specify factor levels for marital status
data <- data %>% 
  mutate(marital_status = case_when(
    marital_status %in% c("Married", "Living with partner") ~ "Married",
    marital_status %in% c("Divorced", "Widowed", "Separated") ~ "Previously Married",
    TRUE ~ as.character(marital_status)
  ))
data$marital_status <- factor(data$marital_status, levels = c("Never Married", "Married", "Previously Married"),
                              labels = c("Never Married", "Married", "Previously Married"))

#set factor born outside us
data$born_outside_us <- factor(data$born_outside_us, levels = c(1,2,4,5), labels = c("Born in US", "Born in Mexico", "Born in other spanish speaking country", "Born in other non-spanish speaking country"))
data <- data %>% 
  mutate(born_outside_us = case_when(
    born_outside_us %in% c("Born in Mexico", "Born in other spanish speaking country", "Born in other non-spanish speaking country") ~ " Born outside US",
    TRUE ~ as.character(born_outside_us)
  ))
data$born_outside_us <- factor(data$born_outside_us, levels = c("Born in US", "Born outside US"), labels = c("Born in US", "Born outside US"))

#factor poverty level
data$poverty_level_category <- factor(data$poverty_level_category, c(2,1,3), c("Poverty Index in (1.30, 1.85)", "Poverty Index <= 1.3", "Poverty Index > 1.85"))

#set missing health insurance values to 'unknown'
data <- data %>% 
  mutate(health_insurance = case_when(
    is.na(health_insurance) ~ "Unknown",
    TRUE ~ as.character(health_insurance)
  ))
data <- data %>% 
  mutate(private_insurance = case_when(
    is.na(private_insurance) ~ "Unknown",
    TRUE ~ as.character(private_insurance)
  ))
data <- data %>% 
  mutate(medicare = case_when(
    is.na(medicare) ~ "Unknown",
    TRUE ~ as.character(medicare)
  ))
data <- data %>% 
  mutate(medicaid = case_when(
    is.na(medicaid) ~ "Unknown",
    TRUE ~ as.character(medicaid)
  ))

#factor health insurance variables
data$health_insurance <- factor(data$health_insurance, c("2","1"), c("Not Covered", "Covered"))
data$private_insurance <- factor(data$private_insurance, c("Unknown", "14"), c("Not Covered", "Covered"))
data$medicare <- factor(data$medicare, c( "Unknown","15"), c("Not Covered", "Covered"))
data$medicaid <- factor(data$medicaid, c( "Unknown", "17"), c("Not Covered", "Covered"))

#factor healthcare visits
data$num_healthcare_visits <- factor(data$num_healthcare_visits, c(1,2,3,4,5), c("0 to 1", "2 to 3","4 to 9","10 to 12", "13 or more"))

#factor food insecurity
data$ever_received_food_stamps <- factor(data$ever_received_food_stamps, c(1,2), c("Yes", "No"))
data$worried_house_run_out_food <- factor(data$worried_house_run_out_food, c(3,1,2), c("Never true", "Often True", "Sometimes true"))
data$food_ran_out <- factor(data$food_ran_out, c(3, 1,2), c("Never true","Often True", "Sometimes true"))

#factor bp
data$high_blood_pressure <- factor(data$high_blood_pressure, c(2,1), c("No", "Yes"))

#factor alcohol consumption
# data$had_12_drinks_in_1yr <- factor(data$had_12_drinks_in_1yr, c(1,2), c("Yes", "No"))

#copy heart attack and stroke to temp columps to keep numeric encodings
data$heart_attack_num <- data$heart_attack
data$stroke_num <- data$stroke

#factor heart attack and stroke values to yes/no for tables and visualization
data$heart_attack <- factor(data$heart_attack, c(1,2), c("Yes", "No"))
data$stroke <- factor(data$stroke, c(1,2), c("Yes", "No"))

#Religious Attendance set levels
data <- data %>% 
  mutate(religious_attendance_num = religious_attendance,
          religious_attendance = case_when(
          religious_attendance < 50 ~ "Less than Weekly",
          religious_attendance %in% c(50,51,52) ~ "Weekly",
          religious_attendance > 52 & religious_attendance < 7777 ~ "More than Weekly",
          religious_attendance >= 7777 ~ "NA",
          TRUE ~ as.character(religious_attendance)
        ))

#religious attendance set factor
data$religious_attendance <- factor(data$religious_attendance, levels = c("Less than Weekly", "Weekly", "More than Weekly"), labels = c("Less than Weekly", "Weekly", "More than Weekly"))

#create cvd variable for modeling
data <- data %>% 
  mutate(cvd = factor(case_when(
    heart_attack == "Yes" | stroke == "Yes" | congestive == "Yes" | coronary == "Yes" | angina == "Yes" ~ 1, 
    TRUE ~ as.numeric(0)
  )))

#filter age 40 and up, and restrict to white, black, hispanic
data <- data %>%
  filter(age >= 40, !(is.na(ethnicity)))
```

### Data and variable outputs

```{r}
#rename data
source_data <- data

#variables of interest
data <- source_data %>% 
  dplyr::select(
         age, 
         num_healthcare_visits, 
         gender, 
         ethnicity, 
         education, 
         marital_status, 
         food_ran_out, 
         health_insurance, 
         home,
         poverty_level_category, 
         emotional_support,
         health_care_access,
         depression,
         high_blood_pressure, 
         cholesterol,
         diabetes,
         cigarette_use,
         BMI,
         religious_attendance,
         cvd
         )
```

```{r, eval = FALSE}
#output variable frequency table to .csv
sumtable(data, out = "csv", file = "variables.csv")

#output full dataset to .csv
source_data %>% 
  write.csv(file = "data.csv")
```



# Univariate Analysis

```{r}
#univariate analysis function
cvd_univ <- function(x, df){
  x <- glm(cvd ~ x, data = df, family = "binomial")
  summary(x)
  blr_model_fit_stats(x)
  chisq.test(data$cvd, data$x)
}
```

```{r}
##TODO: is it necessary to standardize continuous variables for logistic regression?

#Center and Scale continuous variables
data$age <- scale(data$age)
data$depression <- scale(data$depression)
data$BMI <- scale(data$BMI)
#data$height <- scale(data$height)
#data$weight <- scale(data$weight)
```

## Control Variables

### Age 

```{r}
#control variables

age <- glm(cvd ~ age, data = data, family = "binomial")
summary(age)
blr_model_fit_stats(age)
```

### Number of healthcare visits

```{r}
num_healthcare_visits <- glm(cvd ~ num_healthcare_visits, data = data, family = "binomial")
summary(num_healthcare_visits)
blr_model_fit_stats(num_healthcare_visits)
chisq.test(data$cvd, data$num_healthcare_visits)
```

### Gender

```{r}
gender <- glm(cvd ~ gender, data = data, family = "binomial")
summary(gender)
blr_model_fit_stats(gender)
chisq.test(data$cvd, data$gender)
```

## Demographics

### Ethnicity

```{r}
ethnicity <- glm(cvd ~ ethnicity, data = data, family = "binomial")
summary(ethnicity)
blr_model_fit_stats(ethnicity)
chisq.test(data$cvd, data$ethnicity)
```

### education

```{r}
education <- glm(cvd ~ education, data = data, family = "binomial")
summary(education)
blr_model_fit_stats(education)
chisq.test(data$cvd, data$education)
```

### Marital status

```{r}
marital_status <- glm(cvd ~ marital_status, data = data, family = "binomial")
summary(marital_status)
blr_model_fit_stats(marital_status)
chisq.test(data$cvd, data$marital_status)
```

## Social determinants of health

### food ran out

```{r}
food_ran_out <- glm(cvd ~ food_ran_out, data = data, family = "binomial")
summary(food_ran_out)
blr_model_fit_stats(food_ran_out)
chisq.test(data$cvd, data$food_ran_out)
```

### health insurance

```{r}
health_insurance <- glm(cvd ~ health_insurance, data = data, family = "binomial")
summary(health_insurance)
blr_model_fit_stats(health_insurance)
chisq.test(data$cvd, data$health_insurance)
```


### home

```{r}
home <- glm(cvd ~ home, data = data, family = "binomial")
summary(home)
blr_model_fit_stats(home)
chisq.test(data$cvd, data$home)
```


### poverty level category

```{r}
poverty_level_category <- glm(cvd ~ poverty_level_category, data = data, family = "binomial")
summary(poverty_level_category)
blr_model_fit_stats(poverty_level_category)
chisq.test(data$cvd, data$poverty_level_category)
```


### emotional support

```{r}
emotional_support <- glm(cvd ~ emotional_support, data = data, family = "binomial")
summary(emotional_support)
blr_model_fit_stats(emotional_support)
chisq.test(data$cvd, data$emotional_support)
```


### health care access

```{r}
health_care_access <- glm(cvd ~ health_care_access, data = data, family = "binomial")
summary(health_care_access)
blr_model_fit_stats(health_care_access)
chisq.test(data$cvd, data$health_care_access)
```


### depression

```{r}
depression <- glm(cvd ~ depression, data = data, family = "binomial")
summary(depression)
blr_model_fit_stats(depression)
```


## Risk Factors

### BMI

```{r}
BMI <- glm(cvd ~ BMI, data = data, family = "binomial")
summary(BMI)
blr_model_fit_stats(BMI)
chisq.test(data$cvd, data$BMI)
```


### high blood pressure

```{r}
high_blood_pressure <- glm(cvd ~ high_blood_pressure, data = data, family = "binomial")
summary(high_blood_pressure)
blr_model_fit_stats(high_blood_pressure)
chisq.test(data$cvd, data$high_blood_pressure)
```



### cholesterol

```{r}
cholesterol <- glm(cvd ~ cholesterol, data = data, family = "binomial")
summary(cholesterol)
blr_model_fit_stats(cholesterol)
chisq.test(data$cvd, data$cholesterol)
```


### diabetes

```{r}
diabetes <- glm(cvd ~ diabetes, data = data, family = "binomial")
summary(diabetes)
blr_model_fit_stats(diabetes)
chisq.test(data$cvd, data$diabetes)
```



### cigarettes

```{r}
cigarette_use <- glm(cvd ~ cigarette_use, data = data, family = "binomial")
summary(cigarette_use)
blr_model_fit_stats(cigarette_use)
chisq.test(data$cvd, data$cigarette_use)
```


## Religious attendance

```{r}
religious_attendance <- glm(cvd ~ religious_attendance, data = data, family = "binomial")
summary(religious_attendance)
blr_model_fit_stats(religious_attendance)
chisq.test(data$cvd, data$religious_attendance)
```


# Robust Model

```{r}
model <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         gender+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         food_ran_out+ 
         health_insurance+ 
         home+
         poverty_level_category+ 
         emotional_support+
         health_care_access+
         depression+
         high_blood_pressure+ 
         cholesterol+
         diabetes+
         cigarette_use+
         BMI+
         religious_attendance,
         data = data,
         family = "binomial")

summary(model)
blr_model_fit_stats(model)
vif(model)
```

```{r}
# model significance
with(model, pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE))
```

```{r}
# robust model table
model_tbl <- tbl_regression(model, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

model_tbl
```


# Stratified models

```{r}
data_f <- data %>% filter(gender == "Female")
data_m <- data %>% filter(gender == "Male")
```


```{r}
model_f <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         food_ran_out+ 
         health_insurance+ 
         home+
         poverty_level_category+ 
         emotional_support+
         health_care_access+
         depression+
         high_blood_pressure+ 
         cholesterol+
         diabetes+
         cigarette_use+
         BMI+
         religious_attendance,
         data = data_f,
         family = "binomial")

model_m <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         food_ran_out+ 
         health_insurance+ 
         home+
         poverty_level_category+ 
         emotional_support+
         health_care_access+
         depression+
         high_blood_pressure+ 
         cholesterol+
         diabetes+
         cigarette_use+
         BMI+
         religious_attendance,
         data = data_m,
         family = "binomial")
```

## Female

```{r}
summary(model_f)
blr_model_fit_stats(model_f)
vif(model_f)
```

## Male

```{r}
summary(model_m)
blr_model_fit_stats(model_m)
vif(model_m)
```

## Control only

### Female

```{r}
control_f <- glm(cvd ~ age + num_healthcare_visits, data = data_f, family = "binomial")
summary(control_f)
blr_model_fit_stats(control_f)
```

### Male

```{r}
control_m <- glm(cvd ~ age + num_healthcare_visits, data = data_m, family = "binomial")
summary(control_m)
blr_model_fit_stats(control_m)
```


## Control + Demographics

```{r}
model_1f <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status,
         data = data_f,
         family = "binomial")

model_1m <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status,
         data = data_m,
         family = "binomial")
```

### Female

```{r}
summary(model_1f)
blr_model_fit_stats(model_1f)
vif(model_1f)
```

### Male

```{r}
summary(model_1m)
blr_model_fit_stats(model_1m)
vif(model_1m)
```

## Control + demographic + riskfactor

```{r}
model_2f <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         high_blood_pressure+ 
         cholesterol+
         diabetes+
         cigarette_use+
         BMI,
         data = data_f,
         family = "binomial")

model_2m <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         high_blood_pressure+ 
         cholesterol+
         diabetes+
         cigarette_use+
         BMI,
         data = data_m,
         family = "binomial")
```

### Female
```{r}
summary(model_2f)
blr_model_fit_stats(model_2f)
vif(model_2f)
```


### Male

```{r}
summary(model_2m)
blr_model_fit_stats(model_2m)
vif(model_2m)
```

## Control + demographic + SDOH

```{r}
model_3f <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         food_ran_out+
         health_insurance+
         home+
         poverty_level_category+
         emotional_support+
         health_care_access+
         depression+
         religious_attendance,
         data = data_f,
         family = "binomial")

model_3m <- glm(cvd ~ age+ 
         num_healthcare_visits+ 
         ethnicity+ 
         education+ 
         marital_status+ 
         food_ran_out+
         health_insurance+
         home+
         poverty_level_category+
         emotional_support+
         health_care_access+
         depression+
         religious_attendance,
         data = data_m,
         family = "binomial")
```

### Female

```{r}
summary(model_3f)
blr_model_fit_stats(model_3f)
vif(model_3f)
```


### Male

```{r}
summary(model_3m)
blr_model_fit_stats(model_3m)
vif(model_3m)
```

# Odds Ratios and P-Value

## all variables

```{r, warning=FALSE}
model_f_tbl <- tbl_regression(model_f, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

model_m_tbl <- tbl_regression(model_m, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

tbl_merge(tbls = list(model_f_tbl, 
                      model_m_tbl),
          tab_spanner = c("Females", "Males"))
```


## Females

```{r, warning=FALSE}

control_f_tbl <- tbl_regression(control_f, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05) 

model_1f_tbl <- tbl_regression(model_1f, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

model_2f_tbl <- tbl_regression(model_2f, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

model_3f_tbl <- tbl_regression(model_3f, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05) 

tbl_merge(tbls = list(control_f_tbl,
                      model_1f_tbl, 
                      model_2f_tbl, 
                      model_3f_tbl, 
                      model_f_tbl),
          tab_spanner = c("Control", 
                          "Demographics", 
                          "Demo + Risk factors",
                          "Demo + SDOH",
                          "All variables"))
```

## Males

```{r, warning=FALSE}

control_m_tbl <- tbl_regression(control_m, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05) 

model_1m_tbl <- tbl_regression(model_1m, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

model_2m_tbl <- tbl_regression(model_2m, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05)  

model_3m_tbl <- tbl_regression(model_3m, exponentiate = TRUE) %>% 
  modify_table_styling(
    columns = c(estimate, ci),
    rows = reference_row %in% TRUE,
    missing_symbol = "Ref."
  ) %>% 
  modify_column_hide(column = ci) %>% 
  bold_labels() %>% 
  bold_p(t = 0.05) 

tbl_merge(tbls = list(control_m_tbl,
                      model_1m_tbl, 
                      model_2m_tbl, 
                      model_3m_tbl, 
                      model_m_tbl),
          tab_spanner = c("Control", 
                          "Demographics", 
                          "Demo + Risk factors",
                          "Demo + SDOH",
                          "All variables"))
```